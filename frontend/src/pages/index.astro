---
import Layout from '../layouts/Layout.astro';
---

<Layout title="OpenCode Nexus">
  <main class="startup-container">
    <section class="startup-content" aria-busy="true" aria-live="polite">
      <h1 class="startup-title">Preparing your workspace</h1>
      <p class="startup-description">
        Checking your saved connections and routing you to chat.
      </p>
      <p class="startup-hint">
        If this screen does not change, use the navigation to go to Connect.
      </p>
    </section>
  </main>
</Layout>

<style>
  .startup-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    background: hsl(220, 20%, 98%);
  }

  .startup-content {
    max-width: 480px;
    text-align: center;
  }

  .startup-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .startup-description {
    margin-bottom: 0.5rem;
    color: hsl(220, 10%, 40%);
  }

  .startup-hint {
    font-size: 0.9rem;
    color: hsl(220, 10%, 55%);
  }
</style>

<script>
  import { checkEnvironment, invoke } from '../utils/tauri-api';
  import { determineStartupRoute, applyStartupRoute } from '../utils/startup-routing';
  import { subscribeToConnectionEvents } from '../utils/chat-api';
  import { chatStateStore } from '../stores/chat';

  // Track connection event listener unsubscribe function for cleanup
  let unsubscribeConnectionEvents: (() => void) | null = null;

  async function setupConnectionEventListener() {
    if (typeof window === 'undefined') {
      return;
    }

    try {
      const env = checkEnvironment();
      
      // Only setup connection listeners in Tauri or test environments
      if (env.environment === 'tauri' || env.environment === 'test') {
        console.log('ðŸ”— [STARTUP] Setting up connection event listener...');
        
        unsubscribeConnectionEvents = await subscribeToConnectionEvents(
          (message) => {
            // Connected event
            console.log('âœ… [STARTUP] Connected event received:', message);
            chatStateStore.setConnected(true);
            chatStateStore.setError(null);
          },
          (message) => {
            // Disconnected event
            console.log('âš ï¸ [STARTUP] Disconnected event received:', message);
            chatStateStore.setConnected(false);
          },
          (message) => {
            // Error event
            console.log('âŒ [STARTUP] Connection error received:', message);
            chatStateStore.setConnected(false);
            chatStateStore.setError(message);
          },
          (message) => {
            // HealthCheck event (optional)
            console.log('ðŸ’“ [STARTUP] Health check received:', message);
          }
        );
        
        console.log('ðŸ”— [STARTUP] Connection event listener setup complete');
      }
    } catch (error) {
      console.error('âŒ [STARTUP] Failed to setup connection event listener:', error);
      // Don't fail startup if we can't setup listeners - continue with routing
    }
  }

  async function initializeStartupRouting() {
    if (typeof window === 'undefined') {
      return;
    }

    try {
      const env = checkEnvironment();

      let hasSavedConnections = false;

      if (env.environment === 'tauri' || env.environment === 'test') {
        try {
          const connections = await invoke('get_saved_connections');
          hasSavedConnections = Array.isArray(connections) && connections.length > 0;
        } catch (error) {
          console.error('Failed to load saved connections for startup routing:', error);
          hasSavedConnections = false;
        }
      }

      const route = determineStartupRoute({
        environment: env.environment,
        httpBackendUrl: env.httpBackendUrl,
        hasSavedConnections
      });

      applyStartupRoute(route, window.location.pathname, (target) => {
        // Small delay to allow the page to render briefly for testing
        setTimeout(() => {
          window.location.replace(target);
        }, 500);
      });
    } catch (error) {
      console.error('Startup routing failed:', error);
      // Fallback: redirect to connect
      window.location.replace('/connect');
    }
  }

  // Cleanup function for page unload
  function cleanupConnectionListener() {
    if (unsubscribeConnectionEvents) {
      unsubscribeConnectionEvents();
      unsubscribeConnectionEvents = null;
    }
  }

  if (typeof window !== 'undefined') {
    // Setup connection listener first
    setupConnectionEventListener();

    // Then handle routing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeStartupRouting();
      });
    } else {
      initializeStartupRouting();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupConnectionListener);
  }
</script>
