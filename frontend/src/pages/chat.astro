---
import Layout from '../layouts/Layout.astro';
---

<Layout title="OpenCode Nexus - Chat">
  <main class="chat-container">
    <!-- Main Navigation Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1>OpenCode Nexus</h1>
        <div class="user-menu" data-testid="user-menu">
          <span id="username-display">Loading...</span>
          <button id="logout-button" data-testid="logout-button" class="logout-btn">Sign Out</button>
        </div>
        <nav class="dashboard-nav">
          <a href="/chat" class="nav-link active" data-testid="chat-tab">Chat</a>
          <a href="/settings" class="nav-link">Settings</a>
          <a href="/logs" class="nav-link">Logs</a>
          <a href="/help" class="nav-link">Help</a>
        </nav>
      </div>
    </header>

    <!-- Chat Layout: Sessions Sidebar + Main Chat Area -->
    <div id="chat-layout" class="chat-layout">
      <!-- Sessions sidebar will be mounted here -->
      <aside id="sessions-sidebar" class="sessions-sidebar"></aside>

      <!-- Chat interface will be mounted here by JavaScript -->
      <div id="chat-root" class="chat-root">
        <div class="loading-state" id="loading-state">
          <div class="loading-spinner"></div>
          <p>Starting chat session...</p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import ChatInterface from '../components/ChatInterface.svelte';
  import SessionPanel from '../components/SessionPanel.svelte';
  import { chatStore } from '../stores/chat';
  import { invoke } from '@tauri-apps/api/core';
  import {
    chatApiCallbacks,
    initializeChat as initializeChatAPI,
  } from '../utils/chat-api';

  let eventListenerUnsubscribe: (() => void) | null = null;

  // Create error state element safely
  function createErrorElement(): HTMLElement {
    const div = document.createElement('div');
    div.className = 'error-state';

    const heading = document.createElement('h2');
    heading.textContent = 'Chat Unavailable';
    div.appendChild(heading);

    const paragraph = document.createElement('p');
    paragraph.textContent = 'Failed to initialize chat system. Please check your OpenCode server connection.';
    div.appendChild(paragraph);

    const button = document.createElement('button');
    button.textContent = 'Retry';
    button.addEventListener('click', () => {
      window.location.reload();
    });
    div.appendChild(button);

    return div;
  }

  // Initialize chat system
  async function initializeChat() {
    try {
      console.log('ðŸ” Chat: Initializing chat system...');

      // Display username from sessionStorage
      const username = sessionStorage.getItem('username') || 'User';
      const usernameDisplay = document.getElementById('username-display');
      if (usernameDisplay) {
        usernameDisplay.textContent = username;
      }

      // Set up logout functionality
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          // Clean up event listener
          if (eventListenerUnsubscribe) {
            eventListenerUnsubscribe();
          }

          try {
            await invoke('logout_user');
            sessionStorage.clear();
            window.location.href = '/login';
          } catch (error) {
            console.error('Logout failed:', error);
            // Force logout on client side
            sessionStorage.clear();
            window.location.href = '/login';
          }
        });
      }

      // Initialize chat stores
      await chatStore.actions.initialize();

      // Load existing sessions using new chat API
      await chatStore.actions.loadSessions(chatApiCallbacks.sessionLoader);

      // Set up real-time event listener
      eventListenerUnsubscribe = await initializeChatAPI(chatStore.actions.handleChatEvent);
      console.log('ðŸ” Chat: Real-time event listener initialized');

      // Auto-create first session if no sessions exist
      const sessions = await chatApiCallbacks.sessionLoader();
      if (sessions.length === 0) {
        console.log('ðŸ” Chat: No sessions found, creating first chat session...');
        try {
          const newSession = await chatStore.actions.createSession(
            chatApiCallbacks.sessionCreator
          );
          console.log('ðŸ” Chat: Auto-created first session:', newSession.id);
        } catch (error) {
          console.warn('ðŸ” Chat: Failed to auto-create session (continuing anyway):', error);
        }
      }

      // Mount SessionPanel and ChatInterface components
      const chatRoot = document.getElementById('chat-root');
      const sessionsSidebar = document.getElementById('sessions-sidebar');

      if (sessionsSidebar) {
        // Mount SessionPanel component in the sidebar
        const sessionPanel = new SessionPanel({
          target: sessionsSidebar
        });
        console.log('ðŸ” Chat: SessionPanel component mounted successfully');
      } else {
        console.error('ðŸ” Chat: Could not find #sessions-sidebar element');
      }

      if (chatRoot) {
        // Remove loading state
        const loadingState = document.getElementById('loading-state');
        if (loadingState) {
          loadingState.remove();
        }

        // Create and mount the chat interface
        const chatInterface = new ChatInterface({
          target: chatRoot,
          props: {
            onSendMessage: async (content: string) => {
              await chatStore.actions.sendMessage(
                content,
                chatApiCallbacks.messageSender
              );
            },
            onClose: () => {
              // Handle session close if needed
              console.log('Chat session closed');
            }
          }
        });

        console.log('ðŸ” Chat: ChatInterface component mounted successfully');
      } else {
        console.error('ðŸ” Chat: Could not find #chat-root element');
      }

    } catch (error) {
      console.error('ðŸ” Chat: Failed to initialize chat system:', error);

      // Show error state safely using DOM methods
      const chatRoot = document.getElementById('chat-root');
      if (chatRoot) {
        chatRoot.textContent = ''; // Clear existing content
        chatRoot.appendChild(createErrorElement());
      }
    }
  }

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (eventListenerUnsubscribe) {
      eventListenerUnsubscribe();
    }
  });

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', () => {
    initializeChat();
  });

  // Also try immediate initialization
  if (document.readyState !== 'loading') {
    initializeChat();
  }
</script>

<style>
  .chat-container {
    height: 100vh;
    background: hsl(220, 20%, 98%);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-layout {
    flex: 1;
    display: flex;
    gap: 0;
    min-height: 0; /* Important for flex children with scrolling */
  }

  .sessions-sidebar {
    width: 320px;
    flex-shrink: 0;
    border-right: 1px solid hsl(220, 20%, 90%);
    background: hsl(220, 20%, 96%);
    overflow: hidden;
  }

  .chat-root {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    min-width: 0; /* Important for flex children with scrolling */
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 1rem;
    color: hsl(220, 10%, 60%);
  }

  .loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 2px solid hsl(220, 10%, 20%, 0.1);
    border-top: 2px solid hsl(220, 90%, 60%);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state p {
    font-size: 1.125rem;
    font-weight: 500;
  }

  /* Hide loading state when chat is active */
  .chat-root.loaded .loading-state {
    display: none;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .chat-container {
      height: 100vh;
      height: 100dvh; /* Use dynamic viewport height on mobile */
    }

    .chat-layout {
      flex-direction: column;
    }

    .sessions-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid hsl(220, 20%, 90%);
    }

    .chat-root {
      flex: 1;
      min-height: 0;
    }
  }

  /* Tablet responsiveness */
  @media (min-width: 769px) and (max-width: 1024px) {
    .sessions-sidebar {
      width: 280px;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .sessions-sidebar {
      border-right: 2px solid hsl(0, 0%, 0%);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
    }
  }
</style>
