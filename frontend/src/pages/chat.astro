---
import Layout from '../layouts/Layout.astro';
---

<Layout title="OpenCode Nexus - Chat">
  <main class="chat-container">
    <!-- Main Navigation Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1>OpenCode Nexus</h1>
        <div class="user-menu" data-testid="user-menu">
          <span id="username-display">Loading...</span>
          <button id="logout-button" data-testid="logout-button" class="logout-btn">Sign Out</button>
        </div>
        <nav class="dashboard-nav">
          <a href="/chat" class="nav-link active" data-testid="chat-tab">Chat</a>
          <a href="/settings" class="nav-link">Settings</a>
          <a href="/logs" class="nav-link">Logs</a>
          <a href="/help" class="nav-link">Help</a>
        </nav>
      </div>
    </header>

    <!-- Chat interface will be mounted here by JavaScript -->
    <div id="chat-root" class="chat-root">
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner"></div>
        <p>Starting chat session...</p>
      </div>
    </div>
  </main>
</Layout>

<script>
  import ChatInterface from '../components/ChatInterface.svelte';
  import { chatStore } from '../stores/chat';
  import { invoke } from '@tauri-apps/api/core';
  import {
    chatApiCallbacks,
    initializeChat as initializeChatAPI,
  } from '../utils/chat-api';

  let eventListenerUnsubscribe: (() => void) | null = null;

  // Create error state element safely
  function createErrorElement(): HTMLElement {
    const div = document.createElement('div');
    div.className = 'error-state';

    const heading = document.createElement('h2');
    heading.textContent = 'Chat Unavailable';
    div.appendChild(heading);

    const paragraph = document.createElement('p');
    paragraph.textContent = 'Failed to initialize chat system. Please check your OpenCode server connection.';
    div.appendChild(paragraph);

    const button = document.createElement('button');
    button.textContent = 'Retry';
    button.addEventListener('click', () => {
      window.location.reload();
    });
    div.appendChild(button);

    return div;
  }

  // Initialize chat system
  async function initializeChat() {
    try {
      console.log('üîç Chat: Initializing chat system...');

      // Display username from sessionStorage
      const username = sessionStorage.getItem('username') || 'User';
      const usernameDisplay = document.getElementById('username-display');
      if (usernameDisplay) {
        usernameDisplay.textContent = username;
      }

      // Set up logout functionality
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          // Clean up event listener
          if (eventListenerUnsubscribe) {
            eventListenerUnsubscribe();
          }

          try {
            await invoke('logout_user');
            sessionStorage.clear();
            window.location.href = '/login';
          } catch (error) {
            console.error('Logout failed:', error);
            // Force logout on client side
            sessionStorage.clear();
            window.location.href = '/login';
          }
        });
      }

      // Initialize chat stores
      await chatStore.actions.initialize();

      // Load existing sessions using new chat API
      await chatStore.actions.loadSessions(chatApiCallbacks.sessionLoader);

      // Set up real-time event listener
      eventListenerUnsubscribe = await initializeChatAPI(chatStore.actions.handleChatEvent);
      console.log('üîç Chat: Real-time event listener initialized');

      // Auto-create first session if no sessions exist
      const sessions = await chatApiCallbacks.sessionLoader();
      if (sessions.length === 0) {
        console.log('üîç Chat: No sessions found, creating first chat session...');
        try {
          const newSession = await chatStore.actions.createSession(
            chatApiCallbacks.sessionCreator
          );
          console.log('üîç Chat: Auto-created first session:', newSession.id);
        } catch (error) {
          console.warn('üîç Chat: Failed to auto-create session (continuing anyway):', error);
        }
      }

      // Mount ChatInterface component
      const chatRoot = document.getElementById('chat-root');
      if (chatRoot) {
        // Remove loading state
        const loadingState = document.getElementById('loading-state');
        if (loadingState) {
          loadingState.remove();
        }

        // Create and mount the chat interface
        const chatInterface = new ChatInterface({
          target: chatRoot,
          props: {
            onSendMessage: async (content: string) => {
              await chatStore.actions.sendMessage(
                content,
                chatApiCallbacks.messageSender
              );
            },
            onClose: () => {
              // Handle session close if needed
              console.log('Chat session closed');
            }
          }
        });

        console.log('üîç Chat: ChatInterface component mounted successfully');
      } else {
        console.error('üîç Chat: Could not find #chat-root element');
      }

    } catch (error) {
      console.error('üîç Chat: Failed to initialize chat system:', error);

      // Show error state safely using DOM methods
      const chatRoot = document.getElementById('chat-root');
      if (chatRoot) {
        chatRoot.textContent = ''; // Clear existing content
        chatRoot.appendChild(createErrorElement());
      }
    }
  }

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (eventListenerUnsubscribe) {
      eventListenerUnsubscribe();
    }
  });

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', () => {
    initializeChat();
  });

  // Also try immediate initialization
  if (document.readyState !== 'loading') {
    initializeChat();
  }
</script>

<style>
  .chat-container {
    height: 100vh;
    background: hsl(220, 20%, 98%);
    display: flex;
    overflow: hidden;
  }

  .chat-root {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 1rem;
    color: hsl(220, 10%, 60%);
  }

  .loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 2px solid hsl(220, 10%, 20%, 0.1);
    border-top: 2px solid hsl(220, 90%, 60%);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state p {
    font-size: 1.125rem;
    font-weight: 500;
  }

  /* Hide loading state when chat is active */
  .chat-root.loaded .loading-state {
    display: none;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .chat-container {
      height: 100vh;
      height: 100dvh; /* Use dynamic viewport height on mobile */
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
    }
  }
</style>

<script>
  import { invoke, listen } from '../utils/tauri-api';
  import ChatInterface from '../components/ChatInterface.svelte';
  import SessionGrid from '../components/SessionGrid.svelte';
  import { mount } from 'svelte';
  import { get } from 'svelte/store';
  import type { ChatSession, ChatEvent } from '../types/chat';
  import { chatStore } from '../stores/chat';

  // State management using chat stores
  let chatInterfaceComponent: any = null;
  let sessionGridComponent: any = null;

  // DOM elements
  const chatRoot = document.getElementById('chat-root')!;
  async function initializeChat() {
    try {
      console.log('üîç Chat page: Starting initialization...');

      // Check authentication
      console.log('üîç Chat page: Checking authentication...');
      const isAuthenticated = await invoke<boolean>('is_authenticated');
      console.log('üîç Chat page: Authentication status:', isAuthenticated);

      if (!isAuthenticated) {
        console.log('üîç Chat page: Not authenticated, redirecting to /login');
        window.location.href = '/login';
        return;
      }

      // Check onboarding completion
      console.log('üîç Chat page: Checking onboarding status...');
      const onboardingState = await invoke<any>('get_onboarding_state');
      console.log('üîç Chat page: Onboarding state:', onboardingState);

      if (!onboardingState.config?.is_completed) {
        console.log('üîç Chat page: Onboarding not completed, redirecting to /onboarding');
        window.location.href = '/onboarding';
        return;
      }

      console.log('üîç Chat page: All checks passed, loading chat interface...');

      // Initialize offline functionality
      chatStore.actions.initializeOffline();

       // Load existing chat sessions
       await chatStore.actions.loadSessions(async () => {
         return await invoke<ChatSession[]>('get_chat_sessions') || [];
       });

       // Mount components after stores are initialized
       mountComponents();

       // Set up event listeners for real-time updates
       await setupEventListeners();

       // Start message streaming for real-time AI responses
       await startMessageStreaming();

      // Hide loading state only on success
      chatRoot.classList.add("loaded");

      console.log('üîç Chat page: Initialization complete');

    } catch (e) {
      console.error('‚ùå Chat page: Failed to initialize chat:', e);
      const errorMessage = `Failed to initialize chat: ${e}`;
      showError(errorMessage);
    }
  }



  async function setupEventListeners() {
    try {
      // Listen for chat events from backend
      const unlistenChat = await listen('chat-event', (event) => {
        const chatEvent = event.payload as ChatEvent;
        handleChatEvent(chatEvent);
      });

      // Store cleanup
      (window as any).__unlistenChat = unlistenChat;

      console.log('Chat event listeners set up successfully');
    } catch (e) {
      console.error('Failed to setup event listeners:', e);
      // Don't throw - chat can work without real-time events
    }
  }

  async function startMessageStreaming() {
    try {
      await invoke<void>('start_message_stream');
      console.log('Message streaming started');
    } catch (e) {
      console.error('Failed to start message streaming:', e);
      // Don't throw - chat can work without streaming
    }
  }

  function handleChatEvent(event: ChatEvent) {
    console.log('Received chat event:', event);
    chatStore.actions.handleChatEvent(event);
    updateComponents();
  }



  function mountComponents() {
    // Clear loading state
    chatRoot.innerHTML = '';

    // Create layout structure
    const appLayout = document.createElement('div');
    appLayout.className = 'app-layout';

    // Sessions sidebar
    const sessionsSidebar = document.createElement('aside');
    sessionsSidebar.className = 'sessions-sidebar';
    sessionsSidebar.setAttribute('aria-label', 'Chat Sessions');

    // Chat main area
    const chatMain = document.createElement('main');
    chatMain.className = 'chat-main';
    chatMain.setAttribute('role', 'main');
    chatMain.setAttribute('aria-label', 'Chat Interface');

    appLayout.appendChild(sessionsSidebar);
    appLayout.appendChild(chatMain);
    chatRoot.appendChild(appLayout);

    // Get current store values
    const currentSessions = get(chatStore.activeSessions);
    const currentActiveSession = get(chatStore.activeSession);
    const currentLoading = get(chatStore.isLoading);

    // Mount SessionGrid using Svelte 5 mount API
    sessionGridComponent = mount(SessionGrid, {
      target: sessionsSidebar,
      props: {
        sessions: currentSessions,
        activeSessionId: currentActiveSession?.id || null,
        loading: currentLoading
      }
    });

    // Mount ChatInterface using Svelte 5 mount API
    if (currentActiveSession) {
      chatInterfaceComponent = mount(ChatInterface, {
        target: chatMain,
        props: {
          session: currentActiveSession,
          loading: currentLoading
        }
      });
    }
  }

  function updateComponents() {
    if (sessionGridComponent && sessionGridComponent.$set) {
      sessionGridComponent.$set({
        sessions: get(chatStore.activeSessions),
        activeSessionId: get(chatStore.activeSession)?.id || null,
        loading: get(chatStore.isLoading)
      });
    }

    if (chatInterfaceComponent && chatInterfaceComponent.$set) {
      const currentActiveSession = get(chatStore.activeSession);
      if (currentActiveSession) {
        chatInterfaceComponent.$set({
          session: currentActiveSession,
          loading: get(chatStore.isLoading)
        });
      }
    }
  }





  function showError(errorMessage: string) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-banner';
    errorDiv.innerHTML = `
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-message">${errorMessage}</span>
      <button class="error-dismiss" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    chatRoot.insertBefore(errorDiv, chatRoot.firstChild);
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    // Cleanup handled by Svelte components automatically
  });

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChat);
  } else {
    initializeChat();
  }
</script>
<script src="../chat.ts"></script>

<style is:global>
  .app-layout {
    display: flex;
    height: 100vh;
    gap: 0;
  }

  .sessions-sidebar {
    width: 300px;
    flex-shrink: 0;
    border-right: 1px solid hsl(220, 10%, 20%, 0.1);
    background: white;
    overflow-y: auto;
  }

  .chat-main {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  .error-banner {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1.5rem;
    background: hsl(0, 70%, 50%, 0.1);
    border-bottom: 1px solid hsl(0, 70%, 50%, 0.2);
    color: hsl(0, 70%, 40%);
    position: relative;
    z-index: 10;
  }

  .error-icon {
    font-size: 1.125rem;
  }

  .error-message {
    flex: 1;
    font-weight: 500;
  }

  .error-dismiss {
    background: none;
    border: none;
    color: hsl(0, 70%, 40%);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    font-size: 1rem;
    line-height: 1;
  }

  .error-dismiss:hover {
    background: hsl(0, 70%, 50%, 0.1);
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .app-layout {
      flex-direction: column;
    }

    .sessions-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid hsl(220, 10%, 20%, 0.1);
    }

    .error-banner {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
    }
  }

  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    text-align: center;
    color: hsl(220, 15%, 20%);
  }

  .error-state h2 {
    color: hsl(0, 70%, 50%);
    margin-bottom: 1rem;
    font-size: 1.5rem;
  }

  .error-state p {
    margin-bottom: 2rem;
    color: hsl(220, 20%, 60%);
    max-width: 400px;
  }

  .error-state button {
    padding: 0.75rem 1.5rem;
    background: hsl(220, 90%, 60%);
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.3s ease;
  }

  .error-state button:hover {
    background: hsl(220, 90%, 50%);
  }

  /* High Contrast Mode */
  @media (prefers-contrast: high) {
    .sessions-sidebar {
      border-right: 2px solid hsl(220, 30%, 18%);
    }

    .error-banner {
      border-bottom: 2px solid hsl(0, 70%, 50%);
    }
  }
</style>
