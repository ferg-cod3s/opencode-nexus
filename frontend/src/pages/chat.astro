---
import Layout from '../layouts/Layout.astro';
import GlobalOfflineBanner from '../components/GlobalOfflineBanner.svelte';
import ConnectionStatus from '../components/ConnectionStatus.svelte';
---

<Layout title="OpenCode Nexus - Chat">
  <main class="chat-container">
    <!-- Global Status Banner: Offline, Syncing, Errors, Queued Messages -->
    <GlobalOfflineBanner client:load />

    <!-- Connection Status Indicator -->
    <ConnectionStatus client:load />

    <!-- Main Navigation Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1>OpenCode Nexus</h1>
        <div class="user-menu" data-testid="user-menu">
          <span id="username-display">Loading...</span>
          <button id="logout-button" data-testid="logout-button" class="logout-btn">Sign Out</button>
        </div>
        <nav class="dashboard-nav">
          <a href="/chat" class="nav-link active" data-testid="chat-tab">Chat</a>
          <a href="/settings" class="nav-link">Settings</a>
          <a href="/logs" class="nav-link">Logs</a>
          <a href="/help" class="nav-link">Help</a>
        </nav>
      </div>
    </header>

    <!-- Chat Layout: Sessions Sidebar + Main Chat Area -->
    <div id="chat-layout" class="chat-layout">
      <!-- Sessions sidebar will be mounted here -->
      <aside id="sessions-sidebar" class="sessions-sidebar"></aside>

      <!-- Chat interface will be mounted here by JavaScript -->
      <div id="chat-root" class="chat-root">
        <div class="loading-state" id="loading-state">
          <div class="loading-spinner"></div>
          <p>Starting chat session...</p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Sentry is automatically initialized via astro.config.mjs and sentry.client.config.ts
  // Helper function to safely access Sentry with fallback
  function getSentry() {
    return (window as any).Sentry || {
      addBreadcrumb: () => {},
      captureException: () => {},
      setUser: () => {},
      setContext: () => {}
    };
  }

  // Debug: Log script execution start
  console.log('üîç Chat: Script execution started');
 
  let mount: any, get: any, ChatInterface: any, SessionPanel: any, chatStore: any, invoke: any, chatApiCallbacks: any, initializeChatAPI: any;
  
  // Helper function to ensure loading state is removed
  const ensureLoadingStateRemoved = () => {
    const loadingState = document.getElementById('loading-state');
    if (loadingState) {
      console.log('üîç Chat: Removing loading state');
      loadingState.remove();
    }
  };
  
  // Handle imports with error catching
  async function loadDependencies() {
    try {
      console.log('üîç Chat: Loading dependencies...');
      
      const svelteModule = await import('svelte');
      mount = svelteModule.mount;
      get = svelteModule.get;
      
      console.log('üîç Chat: Svelte loaded');
      
      ChatInterface = (await import('../components/ChatInterface.svelte')).default;
      SessionPanel = (await import('../components/SessionPanel.svelte')).default;
      
      console.log('üîç Chat: Components loaded');
      
      const storeModule = await import('../stores/chat');
      chatStore = storeModule.chatStore;
      
      console.log('üîç Chat: Store loaded');
      
      const tauriModule = await import('@tauri-apps/api/core');
      invoke = tauriModule.invoke;
      
      console.log('üîç Chat: Tauri loaded');
      
      const chatApiModule = await import('../utils/chat-api');
      chatApiCallbacks = chatApiModule.chatApiCallbacks;
      initializeChatAPI = chatApiModule.initializeChat;
      
      console.log('üîç Chat: Chat API loaded');
      return true;
    } catch (error) {
      console.error('üîç Chat: Failed to load dependencies:', error);
      return false;
    }
  }

  let eventListenerUnsubscribe: (() => void) | null = null;
  
  // Guard to prevent duplicate initialization
  let chatInitialized = false;

  // Helper function to show connection error
  function showConnectionError(message = "No OpenCode Server Connected") {
    console.log('üîç Chat: Showing connection error state');
    const chatRoot = document.getElementById('chat-root');
    if (chatRoot) {
      // Remove loading state
      const loadingState = document.getElementById('loading-state');
      if (loadingState) {
        loadingState.remove();
      }
      
      chatRoot.innerHTML = `
        <div class="connection-required">
          <h2>${message}</h2>
          <p>To use chat, you need to connect to an OpenCode server first.</p>
          <p>Go to Settings to add a server connection.</p>
          <a href="/settings" class="button">Go to Settings</a>
        </div>
      `;
    }
  }

  // Create error state element safely
  function createErrorElement(): HTMLElement {
    const div = document.createElement('div');
    div.className = 'error-state';

    const heading = document.createElement('h2');
    heading.textContent = 'Chat Unavailable';
    div.appendChild(heading);

    const paragraph = document.createElement('p');
    paragraph.textContent = 'Failed to initialize chat system. Please check your OpenCode server connection.';
    div.appendChild(paragraph);

    const button = document.createElement('button');
    button.textContent = 'Retry';
    button.addEventListener('click', () => {
      window.location.reload();
    });
    div.appendChild(button);

    return div;
  }

  // Initialize chat system
  async function initializeChat() {
    // Guard: prevent duplicate initialization
    if (chatInitialized) {
      console.log('üîç Chat: Already initialized, skipping duplicate initialization');
      return;
    }
    chatInitialized = true;
    
    console.log('üîç Chat: Starting initializeChat function');
    
    // Load dependencies first
    const dependenciesLoaded = await loadDependencies();
    if (!dependenciesLoaded) {
      console.error('üîç Chat: Failed to load dependencies, showing connection error');
      showConnectionError();
      return;
    }

    const sentry = getSentry();
    let connectionError = false; // Track if we have connection issues

    try {
      console.log('üîç Chat: Initializing chat system...');

      // Display username from sessionStorage
      const username = sessionStorage.getItem('username') || 'User';
      const usernameDisplay = document.getElementById('username-display');
      if (usernameDisplay) {
        usernameDisplay.textContent = username;
      }

      // Set up logout functionality
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) {
        logoutButton.addEventListener('click', async () => {
          // Add breadcrumb for logout tracking
          sentry.addBreadcrumb({
            message: 'User initiating logout',
            category: 'authentication',
            level: 'info'
          });

          // Clean up event listener
          if (eventListenerUnsubscribe) {
            eventListenerUnsubscribe();
          }

          try {
            await invoke('logout_user');

            // Clear Sentry user context on logout
            sentry.setUser(null);

            // Add breadcrumb for successful logout
            sentry.addBreadcrumb({
              message: 'User logged out successfully',
              category: 'authentication',
              level: 'info'
            });

            sessionStorage.clear();
            window.location.href = '/login';
          } catch (error) {
            console.error('Logout failed:', error);

            // Log logout error to Sentry
            sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
              contexts: {
                custom: {
                  context: 'logout_error',
                  message: error instanceof Error ? error.message : String(error)
                }
              }
            });

            // Force logout on client side anyway
            sentry.setUser(null);
            sessionStorage.clear();
            window.location.href = '/login';
          }
        });
      }

      // Initialize chat stores
      await chatStore.actions.initialize();

      // Add breadcrumb for chat initialization start
      sentry.addBreadcrumb({
        message: 'Chat initialization started',
        category: 'chat',
        level: 'info'
      });

      console.log('üîç Chat: About to load sessions...');

      // Load existing sessions using new chat API (may fail if no server connection)
      try {
        await chatStore.actions.loadSessions(chatApiCallbacks.sessionLoader);
        console.log('üîç Chat: Sessions loaded successfully');
      } catch (error) {
        const errorMsg = error instanceof Error ? error.message : String(error);
        console.log('üîç Chat: Session loading error caught:', errorMsg);
        
        if (errorMsg.includes('Please connect') || errorMsg.includes('not available in browser environment') || errorMsg.includes('without HTTP backend')) {
          console.warn('üîç Chat: No server connection - showing connection prompt');
          sentry.captureMessage('Chat initialization: No server connected', 'warning');

          const chatRoot = document.getElementById('chat-root');
          if (chatRoot) {
            // Remove loading state first
            ensureLoadingStateRemoved();
            
            chatRoot.innerHTML = `
              <div class="connection-required">
                <h2>No OpenCode Server Connected</h2>
                <p>To use chat, you need to connect to an OpenCode server first.</p>
                <p>Go to Settings to add a server connection.</p>
                <a href="/settings" class="button">Go to Settings</a>
              </div>
            `;
          }
          connectionError = true;
          return; // Stop further initialization
        }
        throw error; // Re-throw if not a connection error
      }

      // Set up real-time event listener with error handling
      try {
        eventListenerUnsubscribe = await initializeChatAPI(chatStore.actions.handleChatEvent);
        console.log('üîç Chat: Real-time event listener initialized');

        // Add breadcrumb for real-time listener
        sentry.addBreadcrumb({
          message: 'Real-time event listener initialized',
          category: 'chat',
          level: 'info'
        });
      } catch (error) {
        const errorMsg = error instanceof Error ? error.message : String(error);
        console.log('üîç Chat: Event listener error:', errorMsg);
        
        if (errorMsg.includes('Please connect') || errorMsg.includes('not available in browser environment') || errorMsg.includes('without HTTP backend')) {
          console.warn('üîç Chat: Server connection lost during initialization');
          sentry.captureMessage('Chat: Event stream failed - no server connected', 'warning');

          // If we already showed connection required, don't duplicate
          const chatRoot = document.getElementById('chat-root');
          if (chatRoot && !chatRoot.querySelector('.connection-required')) {
            // Remove loading state
            ensureLoadingStateRemoved();
            
            chatRoot.innerHTML = `
              <div class="connection-required">
                <h2>No OpenCode Server Connected</h2>
                <p>To use chat, you need to connect to an OpenCode server first.</p>
                <p>Go to Settings to add a server connection.</p>
                <a href="/settings" class="button">Go to Settings</a>
              </div>
            `;
            connectionError = true;
          }
        } else {
          console.error('üîç Chat: Failed to initialize event listener:', error);
          sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
            contexts: {
              custom: {
                context: 'event_stream_init_error',
                message: errorMsg
              }
            }
          });
        }
        // Continue with chat even if event stream fails - user can still view cached sessions
      }

      // Auto-create first session if no sessions exist
      const sessions = get(chatStore.sessions);
      if (sessions.length === 0) {
        console.log('üîç Chat: No sessions found, creating first chat session...');
        try {
          const newSession = await chatStore.actions.createSession(
            chatApiCallbacks.sessionCreator
          );
          console.log('üîç Chat: Auto-created first session:', newSession.id);

          // Add breadcrumb for successful session creation
          sentry.addBreadcrumb({
            message: `Auto-created first chat session: ${newSession.id}`,
            category: 'chat',
            level: 'info'
          });
        } catch (error) {
          console.warn('üîç Chat: Failed to auto-create session (continuing anyway):', error);

          // Log session creation error to Sentry but continue
          sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
            contexts: {
              custom: {
                context: 'session_auto_creation_error',
                message: error instanceof Error ? error.message : String(error),
                severity: 'warning'
              }
            }
          });
        }
      }

      // Skip component mounting if we have connection errors
      if (connectionError) {
        console.log('üîç Chat: Skipping component mounting due to connection errors');
        return;
      }

      // Mount SessionPanel and ChatInterface components
      const chatRoot = document.getElementById('chat-root');
      const sessionsSidebar = document.getElementById('sessions-sidebar');

      if (sessionsSidebar) {
        // Mount SessionPanel component in the sidebar
        try {
          mount(SessionPanel, {
            target: sessionsSidebar
          });
          console.log('üîç Chat: SessionPanel component mounted successfully');
 
          // Add breadcrumb for successful component mount
          sentry.addBreadcrumb({
            message: 'SessionPanel component mounted',
            category: 'chat',
            level: 'info'
          });
        } catch (error) {
          console.error('üîç Chat: Failed to mount SessionPanel:', error);
 
          // Log component mount error to Sentry
          sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
            contexts: {
              custom: {
                context: 'component_mount_error',
                component: 'SessionPanel',
                message: error instanceof Error ? error.message : String(error)
              }
            }
          });
        }
      } else {
        console.error('üîç Chat: Could not find #sessions-sidebar element');

        // Log missing element error
        sentry.captureException(new Error('Missing #sessions-sidebar element'), {
          contexts: {
            custom: {
              context: 'missing_dom_element',
              element: '#sessions-sidebar'
            }
          }
        });
      }

      if (chatRoot) {
        // Remove loading state
        ensureLoadingStateRemoved();
 
        // Create and mount the chat interface
        try {
          mount(ChatInterface, {
            target: chatRoot,
            props: {
              onSendMessage: async (content: string, model?: { provider_id: string; model_id: string }) => {
                try {
                  // Add breadcrumb for message send
                  sentry.addBreadcrumb({
                    message: `Sending message (${content.length} chars)`,
                    category: 'chat',
                    level: 'info'
                  });
 
                  await chatStore.actions.sendMessage(
                    content,
                    chatApiCallbacks.messageSender,
                    model
                  );
                } catch (error) {
                  console.error('Failed to send message:', error);
 
                  // Log message send error to Sentry
                  sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
                    contexts: {
                      custom: {
                        context: 'message_send_error',
                        messageLength: content.length,
                        message: error instanceof Error ? error.message : String(error)
                      }
                    }
                  });
                }
              },
              onClose: () => {
                // Handle session close if needed
                console.log('Chat session closed');
 
                // Add breadcrumb for session close
                sentry.addBreadcrumb({
                  message: 'Chat session closed',
                  category: 'chat',
                  level: 'info'
                });
              }
            }
          });
 
          console.log('üîç Chat: ChatInterface component mounted successfully');
 
          // Add breadcrumb for successful component mount
          sentry.addBreadcrumb({
            message: 'ChatInterface component mounted',
            category: 'chat',
            level: 'info'
          });
        } catch (error) {
          console.error('üîç Chat: Failed to mount ChatInterface:', error);

          // Log component mount error to Sentry
          sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
            contexts: {
              custom: {
                context: 'component_mount_error',
                component: 'ChatInterface',
                message: error instanceof Error ? error.message : String(error)
              }
            }
          });

          // Show error state
          chatRoot.textContent = ''; // Clear existing content
          chatRoot.appendChild(createErrorElement());
        }
      } else {
        console.error('üîç Chat: Could not find #chat-root element');

        // Log missing element error
        sentry.captureException(new Error('Missing #chat-root element'), {
          contexts: {
            custom: {
              context: 'missing_dom_element',
              element: '#chat-root'
            }
          }
        });
      }

    } catch (error) {
      console.error('üîç Chat: Failed to initialize chat system:', error);

      // Always ensure loading state is removed on any error
      ensureLoadingStateRemoved();

      // Capture the initialization error with full context
      sentry.captureException(error instanceof Error ? error : new Error(String(error)), {
        contexts: {
          custom: {
            context: 'chat_initialization_failed',
            message: error instanceof Error ? error.message : String(error)
          }
        }
      });

      // Add breadcrumb for the failure
      sentry.addBreadcrumb({
        message: `Chat initialization failed: ${error instanceof Error ? error.message : String(error)}`,
        category: 'chat',
        level: 'error'
      });

      // Show error state safely using DOM methods
      const chatRoot = document.getElementById('chat-root');
      if (chatRoot) {
        chatRoot.textContent = ''; // Clear existing content
        chatRoot.appendChild(createErrorElement());
      }
    } finally {
      // CRITICAL: Always ensure loading state is removed
      ensureLoadingStateRemoved();
      console.log('üîç Chat: Initialization complete (success or failure)');
    }
  }

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (eventListenerUnsubscribe) {
      eventListenerUnsubscribe();
    }
  });

  // Timeout fallback to prevent infinite loading
  setTimeout(() => {
    const loadingState = document.getElementById('loading-state');
    if (loadingState && loadingState.style.display !== 'none') {
      console.warn('üîç Chat: Initialization timeout - forcing connection error state');
      showConnectionError("Chat initialization timed out");
    }
  }, 15000); // 15 second timeout

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üîç Chat: DOMContentLoaded event fired');
    initializeChat().catch(error => {
      console.error('üîç Chat: Initialization failed:', error);
      showConnectionError("Chat initialization failed");
    });
  });

  // Also try immediate initialization only if document is already fully loaded
  if (document.readyState === 'complete') {
    console.log('üîç Chat: Document already loaded, initializing immediately');
    initializeChat().catch(error => {
      console.error('üîç Chat: Immediate initialization failed:', error);
      showConnectionError("Chat initialization failed");
    });
  }
</script>

<style>
  /* OpenCode-inspired Chat Page Styling */
  .chat-container {
    height: 100vh;
    background: var(--background-base);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header - OpenCode style */
  .dashboard-header {
    background: var(--background-surface);
    color: var(--text-strong);
    padding: var(--spacing-3) var(--spacing-6);
    border-bottom: 1px solid var(--border-weak);
    flex-shrink: 0;
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-4);
    flex-wrap: wrap;
  }

  .header-content h1 {
    font-size: 1.25rem;
    font-weight: var(--font-weight-semibold);
    margin: 0;
    color: var(--text-strong);
  }

  .user-menu {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    color: var(--text-base);
    font-size: var(--font-size-small);
  }

  .logout-btn {
    background: var(--button-secondary-bg);
    color: var(--text-strong);
    border: 1px solid var(--border-base);
    border-radius: var(--radius-md);
    padding: var(--spacing-2) var(--spacing-3);
    font-size: var(--font-size-small);
    cursor: pointer;
    transition: all 0.15s ease;
    min-height: 36px;
  }

  .logout-btn:hover {
    background: var(--button-ghost-hover);
  }

  .logout-btn:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
  }

  .dashboard-nav {
    display: flex;
    gap: var(--spacing-1);
  }

  .nav-link {
    color: var(--text-base);
    text-decoration: none;
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-md);
    transition: all 0.15s ease;
    font-size: var(--font-size-small);
    font-weight: var(--font-weight-medium);
  }

  .nav-link:hover {
    color: var(--text-strong);
    background: var(--button-ghost-hover);
  }

  .nav-link.active {
    color: var(--accent-primary);
    background: var(--active-highlight);
  }

  .chat-layout {
    flex: 1;
    display: flex;
    gap: 0;
    min-height: 0;
  }

  .sessions-sidebar {
    width: 280px;
    flex-shrink: 0;
    border-right: 1px solid var(--border-weak);
    background: var(--background-weak);
    overflow: hidden;
  }

  .chat-root {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    min-width: 0;
    background: var(--background-base);
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: var(--spacing-4);
    color: var(--text-muted);
  }

  .loading-spinner {
    width: 2rem;
    height: 2rem;
    border: 2px solid var(--border-weak);
    border-top: 2px solid var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state p {
    font-size: var(--font-size-large);
    font-weight: var(--font-weight-medium);
    color: var(--text-base);
  }

  /* Hide loading state when chat is active */
  .chat-root.loaded .loading-state {
    display: none;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .chat-container {
      height: 100vh;
      height: 100dvh;
    }

    .chat-layout {
      flex-direction: column;
    }

    .sessions-sidebar {
      width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid var(--border-weak);
    }

    .chat-root {
      flex: 1;
      min-height: 0;
    }
  }

  /* Tablet responsiveness */
  @media (min-width: 769px) and (max-width: 1024px) {
    .sessions-sidebar {
      width: 260px;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .sessions-sidebar {
      border-right: 2px solid currentColor;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
    }
  }

  /* Connection required state - OpenCode style */
  .connection-required {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: var(--spacing-6);
    padding: var(--spacing-8);
    text-align: center;
    background: var(--background-base);
  }

  .connection-required h2 {
    font-size: 1.5rem;
    font-weight: var(--font-weight-semibold);
    color: var(--text-strong);
    margin: 0;
  }

  .connection-required p {
    color: var(--text-base);
    margin: 0;
    line-height: var(--line-height-relaxed);
    max-width: 400px;
  }

  .connection-required .button {
    display: inline-block;
    padding: var(--spacing-3) var(--spacing-6);
    background: var(--button-primary-bg);
    color: var(--button-primary-text);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    transition: filter 0.15s ease;
  }

  .connection-required .button:hover {
    filter: brightness(1.1);
  }

  /* Connection error banner */
  .connection-error {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-4);
    background: rgba(252, 213, 58, 0.1);
    border-bottom: 1px solid var(--accent-warning);
    color: var(--accent-warning);
    font-weight: var(--font-weight-medium);
  }

  .connection-error p {
    margin: 0;
  }

  /* Error state */
  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: var(--spacing-6);
    padding: var(--spacing-8);
    text-align: center;
  }

  .error-state h2 {
    font-size: 1.5rem;
    font-weight: var(--font-weight-semibold);
    color: var(--accent-error);
    margin: 0;
  }

  .error-state p {
    color: var(--text-base);
    margin: 0;
  }

  .error-state button {
    padding: var(--spacing-3) var(--spacing-6);
    background: var(--button-primary-bg);
    color: var(--button-primary-text);
    border: none;
    border-radius: var(--radius-md);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: filter 0.15s ease;
  }

  .error-state button:hover {
    filter: brightness(1.1);
  }
</style>
