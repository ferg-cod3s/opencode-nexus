#!/bin/bash

# Pre-commit hook for GitHub Actions workflow validation
# This hook runs local testing before allowing commits
#
# ðŸš¨ TESTING POLICY: 100% PASS RATE REQUIRED
# All tests must pass. No exceptions. No skipping.
# If tests fail, fix them before committing.

set -e

echo "ðŸ” Running pre-commit checks..."
echo "ðŸ“‹ Policy: 100% test pass rate required - no exceptions"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_test_failure_help() {
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}ðŸš¨ TESTS FAILED - COMMIT BLOCKED${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "100% test pass rate is required. Here's what to do:"
    echo ""
    echo "  1. Read the failing test to understand expected behavior"
    echo "  2. Determine: Is the test outdated, or is your change incorrect?"
    echo "  3. If your change is correct: UPDATE the test to reflect new behavior"
    echo "  4. If your change is wrong: FIX your code"
    echo "  5. Run tests again: cargo test && cd frontend && bun test"
    echo ""
    echo -e "${YELLOW}âŒ DO NOT:${NC}"
    echo "  - Skip tests with .skip() or #[ignore]"
    echo "  - Comment out failing tests"
    echo "  - Use --no-verify to bypass this hook"
    echo ""
    echo -e "${GREEN}See AGENTS.md for full testing policy${NC}"
    echo ""
}

# Check if Act CLI is available
if ! command -v act &> /dev/null; then
    print_warning "Act CLI not found. Install it with: brew install act"
    echo "Skipping GitHub Actions validation..."
    exit 0
fi

# Check if Docker is running
if ! docker info &> /dev/null; then
    print_warning "Docker is not running. Start Docker to enable workflow validation."
    echo "Skipping GitHub Actions validation..."
    exit 0
fi

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

# Check if any GitHub Actions workflows were changed
WORKFLOW_CHANGED=false
for file in $CHANGED_FILES; do
    if [[ "$file" == .github/workflows/*.yml ]] || [[ "$file" == .github/workflows/*.yaml ]]; then
        WORKFLOW_CHANGED=true
        break
    fi
done

# Check if any source code was changed
SOURCE_CHANGED=false
for file in $CHANGED_FILES; do
    if [[ "$file" == frontend/** ]] || [[ "$file" == src-tauri/** ]]; then
        SOURCE_CHANGED=true
        break
    fi
done

# Run workflow validation if workflows changed
if [ "$WORKFLOW_CHANGED" = true ]; then
    print_status "GitHub Actions workflows changed, validating syntax..."
    
    # Validate YAML syntax
    for file in $CHANGED_FILES; do
        if [[ "$file" == .github/workflows/*.yml ]] || [[ "$file" == .github/workflows/*.yaml ]]; then
            if command -v yamllint &> /dev/null; then
                yamllint "$file" || {
                    print_error "YAML syntax error in $file"
                    exit 1
                }
            else
                # Basic YAML validation using Python
                python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || {
                    print_error "YAML syntax error in $file"
                    exit 1
                }
            fi
            print_status "YAML syntax valid: $file"
        fi
    done
    
    # Test workflows with Act (if Docker is available)
    print_status "Testing GitHub Actions workflows locally..."
    
    # Test specific workflows that were changed
    for file in $CHANGED_FILES; do
        if [[ "$file" == .github/workflows/*.yml ]] || [[ "$file" == .github/workflows/*.yaml ]]; then
            workflow_name=$(basename "$file" .yml)
            workflow_name=$(basename "$workflow_name" .yaml)
            
            echo "Testing workflow: $workflow_name"
            
            # Run Act with dry-run to validate syntax
            if act -W "$file" --dryrun 2>/dev/null; then
                print_status "Workflow validation passed: $workflow_name"
            else
                print_error "Workflow validation failed: $workflow_name"
                echo "Run 'act -W $file' for details"
                exit 1
            fi
        fi
    done
fi

# Run basic tests if source code changed
if [ "$SOURCE_CHANGED" = true ]; then
    print_status "Source code changed, running basic tests..."
    
    # Frontend tests
    if [[ "$CHANGED_FILES" == *frontend* ]]; then
        echo "Running frontend tests..."
        cd frontend
        
        # Type check
        if bun run typecheck; then
            print_status "Frontend type check passed"
        else
            print_error "Frontend type check failed"
            exit 1
        fi
        
        # Lint
        if bun run lint --max-warnings 0; then
            print_status "Frontend lint passed"
        else
            print_error "Frontend lint failed"
            exit 1
        fi
        
        # Unit tests
        if bun test; then
            print_status "Frontend unit tests passed"
        else
            print_error "Frontend unit tests failed"
            print_test_failure_help
            exit 1
        fi
        
        cd ..
    fi
    
    # Backend tests
    if [[ "$CHANGED_FILES" == *src-tauri* ]]; then
        echo "Running backend tests..."
        cd src-tauri
        
        # Format check
        if cargo fmt --all -- --check; then
            print_status "Backend format check passed"
        else
            print_error "Backend format check failed"
            echo "Run 'cargo fmt' to fix formatting"
            exit 1
        fi
        
        # Clippy
        if cargo clippy --all-targets --all-features -- -D warnings; then
            print_status "Backend clippy passed"
        else
            print_error "Backend clippy failed"
            exit 1
        fi
        
        # Unit tests
        if cargo test; then
            print_status "Backend unit tests passed"
        else
            print_error "Backend unit tests failed"
            print_test_failure_help
            exit 1
        fi
        
        cd ..
    fi
fi

# Check for common issues
print_status "Checking for common issues..."

# Check for secrets in committed files
for file in $CHANGED_FILES; do
    if git show ":$file" | grep -E "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]*['\"]" &>/dev/null; then
        print_error "Potential secret detected in $file"
        echo "Please remove secrets before committing"
        exit 1
    fi
done

# Check for console.log statements in frontend code
for file in $CHANGED_FILES; do
    if [[ "$file" == frontend/**/*.{ts,js,svelte} ]]; then
        if git show ":$file" | grep -E "console\.(log|warn|error|debug)" &>/dev/null; then
            print_warning "console.log detected in $file"
            echo "Consider removing console statements before committing"
        fi
    fi
done

# Check for TODO/FIXME comments
for file in $CHANGED_FILES; do
    if git show ":$file" | grep -E "(TODO|FIXME|HACK)" &>/dev/null; then
        print_warning "TODO/FIXME comment detected in $file"
        echo "Consider addressing these items or creating issues"
    fi
done

print_status "All pre-commit checks passed! ðŸŽ‰"
exit 0