name: License Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check licenses with Apache SkyWalking Eyes
        uses: apache/skywalking-eyes/header@v0.6.0
        with:
          config: .licenserc.yaml
          mode: check

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check Rust dependencies licenses
        run: |
          cd src-tauri
          cargo license --json > ../licenses-rust.json

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install

      - name: Check NPM dependencies licenses
        run: |
          cd frontend
          npx license-checker --json > ../licenses-npm.json

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            licenses-rust.json
            licenses-npm.json

  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-sbom
        run: cargo install cargo-sbom

      - name: Generate Rust SBOM
        run: |
          cd src-tauri
          cargo sbom > ../sbom-rust.json

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install

      - name: Generate NPM SBOM with CycloneDX
        run: |
          cd frontend
          npx @cyclonedx/cyclonedx-npm --output-file ../sbom-npm.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: |
            sbom-rust.json
            sbom-npm.json

  license-summary:
    name: License Summary
    runs-on: ubuntu-latest
    needs: [license-check, sbom-generation]
    if: always()
    steps:
      - name: License check summary
        run: |
          echo "### License Compliance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| License Headers | ${{ needs.license-check.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom-generation.result == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📦 License reports and SBOM files are available as workflow artifacts." >> $GITHUB_STEP_SUMMARY
