name: iOS TestFlight Release (Clean)

# DISABLED: Use ios-build-enhanced.yml instead
# To re-enable, change 'never-trigger' back to 'main'
on:
  push:
    tags:
      - 'ios-v*'
    branches:
      - 'never-trigger'
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'Upload to TestFlight'
        required: false
        default: true
        type: boolean
      tag_name:
        description: 'Release tag name'
        required: false
        type: string

jobs:
  build-ios:
    name: iOS TestFlight Build
    runs-on: self-hosted
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up environment variables
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name }}"
          VERSION_NUMBER=$(echo "$TAG_NAME" | sed 's/^[^0-9]*//;s/-.*$//')
          BUILD_NUMBER=$(git rev-list --count HEAD)
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          
          echo "Version: $VERSION_NUMBER (Build: $BUILD_NUMBER)"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Verify Rust Installation
        run: |
          echo "ðŸ” Verifying Rust installation..."
          rustc --version
          cargo --version
          echo "âœ… Rust verified as installed"

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Homebrew and dependencies
        run: |
          # Ensure homebrew is in PATH for self-hosted runner
          eval "$(/opt/homebrew/bin/brew shellenv)" || eval "$(/usr/local/bin/brew shellenv)" || true
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          
          # Install xcodegen if not present
          if ! command -v xcodegen &> /dev/null; then
            echo "Installing xcodegen..."
            brew install xcodegen
          fi
          
          # Install cocoapods if not present
          if ! command -v pod &> /dev/null; then
            echo "Installing cocoapods..."
            brew install cocoapods
          fi

      - name: Setup caching
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.bun/install/cache
            frontend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock', '**/bun.lockb', 'src-tauri/Cargo.toml', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
            ${{ runner.os }}-

      - name: Cache Rust target
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: ${{ runner.os }}-rust-target-${{ hashFiles('**/Cargo.lock', 'src-tauri/src/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-rust-target-

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Build frontend (production)
        run: |
          cd frontend
          bun run build
        env:
          NODE_ENV: production

      - name: Verify Tauri CLI
        run: |
          echo "ðŸ” Checking Tauri CLI installation..."
          if command -v cargo-tauri >/dev/null 2>&1; then
            TAURI_VERSION=$(cargo tauri --version 2>/dev/null || echo "Unknown")
            echo "âœ… Tauri CLI already installed: $TAURI_VERSION"
          else
            echo "ðŸ“¦ Installing Tauri CLI..."
            cargo install tauri-cli --version "^2" --locked
            echo "âœ… Tauri CLI installed successfully"
          fi

      - name: Pre-build Rust library for iOS
        id: prebuild
        run: |
          echo "::group::Pre-building Rust library for iOS"
          START_TIME=$(date +%s)
          
          cd src-tauri
          echo "Building Rust code for iOS (aarch64-apple-ios)..."
          
          # Build with correct library name from Cargo.toml
          RUST_BACKTRACE=0 cargo build --target aarch64-apple-ios --release --lib
          
          RUST_BUILD_TIME=$(($(date +%s) - START_TIME))
          echo "::notice::Rust build completed in ${RUST_BUILD_TIME}s"
          
          # Verify library was built
          LIB_NAME="libsrc_tauri_lib.a"
          RUST_LIB_PATH="target/aarch64-apple-ios/release/$LIB_NAME"
          
          echo "ðŸ” Checking Rust build output..."
          echo "All files in target directory:"
          find target/aarch64-apple-ios/release -type f -name "*.a" -exec basename {} \; | sort
          echo "Full file listing with details:"
          ls -la target/aarch64-apple-ios/release/*.a 2>/dev/null || echo "No .a files found"
          
          if [ ! -f "$RUST_LIB_PATH" ]; then
            echo "âŒ ERROR: Expected library not found at $RUST_LIB_PATH"
            echo "Looking for alternative library names..."
            for alt_lib in target/aarch64-apple-ios/release/*.a; do
              if [ -f "$alt_lib" ]; then
                echo "âœ… Found alternative library: $(basename $alt_lib)"
                LIB_NAME=$(basename "$alt_lib")
                RUST_LIB_PATH="$alt_lib"
                break
              fi
            done
            
            if [ ! -f "$RUST_LIB_PATH" ]; then
              echo "âŒ No suitable library found!"
              exit 1
            fi
          fi
          
          echo "âœ… Rust library built successfully: $LIB_NAME"
          echo "::endgroup::"
        env:
          RUST_LOG: warn

      - name: Setup iOS Xcode project
        run: |
          cd src-tauri
          
          # Initialize the iOS project (creates gen/apple/)
          echo "ðŸ”§ Initializing iOS project..."
          cargo tauri ios init
          
          # Create the Externals directory structure
          echo "ðŸ“ Creating directory structure..."
          mkdir -p gen/apple/Externals/arm64/Release
          mkdir -p gen/apple/Externals/arm64/release
          
          # Copy the pre-built library to where Xcode expects it
          echo "ðŸ“¦ Copying pre-built library..."
          LIB_NAME="libsrc_tauri_lib.a"
          RUST_LIB_PATH="target/aarch64-apple-ios/release/$LIB_NAME"
          
          cp "$RUST_LIB_PATH" gen/apple/Externals/arm64/Release/libapp.a
          cp "$RUST_LIB_PATH" gen/apple/Externals/arm64/release/libapp.a
          
          echo "âœ… Library copied to both locations"

      - name: Build iOS app
        run: |
          cd src-tauri
          
          # Build the iOS app
          echo "ðŸ”¨ Building iOS app..."
          
          # Build for iOS (arm64)
          cargo tauri ios build --verbose
          
          echo "âœ… iOS app build completed"

      - name: Build and Archive IPA
        run: |
          cd src-tauri
          
          # Build and archive for iOS
          echo "ðŸ“± Building and archiving IPA..."
          
          # Build the Xcode project
          xcodebuild -project gen/apple/Opencode Nexus.xcodeproj \
            -scheme Opencode Nexus \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath gen/apple/build \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="${{ secrets.APPLE_SIGNING_IDENTITY }}" \
            PROVISIONING_PROFILE="${{ secrets.APPLE_PROVISIONING_PROFILE }}" \
            clean build

      - name: Export IPA
        run: |
          cd src-tauri
          
          # Export the IPA from archive
          echo "ðŸ“¦ Exporting IPA..."
          
          xcodebuild -exportArchive \
            -archivePath gen/apple/build/Opencode Nexus.xcarchive \
            -exportPath gen/apple/build \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates

      - name: Upload to TestFlight
        if: inputs.upload_to_testflight == 'true'
        run: |
          cd src-tauri
          
          # Upload to TestFlight
          echo "ðŸš€ Uploading to TestFlight..."
          
          xcrun altool --upload-app \
            --type ios \
            --file gen/apple/build/Opencode Nexus.ipa \
            --username "${{ secrets.APPLE_ID_EMAIL }}" \
            --password "${{ secrets.APPLE_ID_PASSWORD }}" \
            --asc-public-id "${{ secrets.APPLE_ASC_PUBLIC_ID }}" \
            --asc-provider "${{ secrets.APPLE_ASC_PROVIDER }}" \
            --verbose

      - name: Build failure analysis
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ iOS Build Failed
          
          ### ðŸ” Troubleshooting Checklist
          1. **Rust Build**: Check if Rust library compiled successfully
          2. **Library Copy**: Verify library was copied to correct locations
          3. **Xcode Build**: Check xcodebuild command and certificates
          4. **Code Signing**: Verify certificate and provisioning profile are current
          5. **Dependencies**: Check Rust toolchain and Xcode compatibility
          
          ### ðŸ› ï¸ Common Issues & Solutions
          - **Rust compilation errors**: Check Rust code and Cargo.toml dependencies
          - **Code signing errors**: Verify certificate and provisioning profile validity
          - **Xcode build failures**: Check iOS SDK and target compatibility
          - **TestFlight upload fails**: Verify API key permissions and IPA format
          
          ### ðŸ“Š Debug Information
          - **Rust Version**: $(rustc --version)
          - **Tauri CLI**: $(cargo tauri --version 2>/dev/null || echo "Not found")
          - **Xcode Version**: $(xcodebuild -version | head -1)
          - **iOS SDK**: $(xcrun --sdk iphoneos --show-sdk-version)
          
          Check job logs above for specific error details.
          EOF