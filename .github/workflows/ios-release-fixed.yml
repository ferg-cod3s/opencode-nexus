name: iOS TestFlight Release (Fixed)

on:
  push:
    tags:
      - 'ios-v*'
    branches:
      - 'main'
      - 'test-ios-build'
      - 'release'
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'Upload to TestFlight'
        required: false
        default: true
        type: boolean
      tag_name:
        description: 'Release tag name'
        required: false
        type: string

jobs:
  detect-runner:
    name: Detect Runner for iOS Build
    uses: ./.github/workflows/runner-detection.yml
    with:
      preferred_runner: 'self-hosted'
      fallback_runner: 'macos-14'
      require_macos: true
      check_disk_space: 10

  build-ios:
    name: iOS TestFlight Build (Fixed)
    runs-on: ${{ needs.detect-runner.outputs.runner_type }}
    needs: detect-runner
    timeout-minutes: 90
    if: always() && needs.detect-runner.result == 'success'

    steps:
      - name: Display Cost Warning
        if: needs.detect-runner.outputs.cost_warning != ''
        run: |
          echo "::warning::${{ needs.detect-runner.outputs.cost_warning }}"
          echo ""
          echo "üí° **Cost Impact**: This iOS build is running on GitHub-hosted runner"
          echo "- **Current cost**: $0.08/minute"
          echo "- **Estimated build time**: 15-20 minutes"
          echo "- **Estimated cost**: $1.20-$1.60"
          echo ""
          echo "üí∞ **Savings with self-hosted runner**: $1.20-$1.60 per build"
          echo ""
          echo "üîß **To fix this**:"
          echo "1. Check self-hosted runner status: https://github.com/${{ github.repository }}/settings/actions/runners"
          echo "2. Restart runner: cd ~/github-runner && ./svc.restart"
          echo "3. Check logs: cd ~/github-runner && tail -f _diag/Runner_*.log"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up environment variables
        run: |
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name }}"
          VERSION_NUMBER=$(echo "$TAG_NAME" | sed 's/^[^0-9]*//;s/-.*$//')
          BUILD_NUMBER=$(git rev-list --count HEAD)

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

          echo "Version: $VERSION_NUMBER (Build: $BUILD_NUMBER)"

      - name: Validate Runner Environment
        run: |
          echo "üñ•Ô∏è Validating runner environment for iOS build..."
          echo "Runner Type: ${{ needs.detect-runner.outputs.runner_type }}"
          echo "Operating System: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "Available Disk Space: $(df -h . | tail -1 | awk '{print $4}')"
          
          # Verify we're on macOS
          if [ "$(uname -s)" != "Darwin" ]; then
            echo "::error::iOS builds require macOS but detected $(uname -s)"
            exit 1
          fi
          
          # Check available disk space (minimum 10GB)
          AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
          AVAILABLE_SPACE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          
          if [ "$AVAILABLE_SPACE_GB" -lt 10 ]; then
            echo "::error::Insufficient disk space: ${AVAILABLE_SPACE_GB}GB < 10GB required"
            echo "Please free up disk space on the runner"
            exit 1
          fi
          
          echo "‚úÖ Runner environment validated for iOS build"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup enhanced caching
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.bun/install/cache
            frontend/node_modules
            src-tauri/target/debug
            src-tauri/target/release
          key: ${{ runner.os }}-deps-v2-${{ hashFiles('**/Cargo.lock', '**/bun.lockb', 'src-tauri/Cargo.toml', 'frontend/package.json', 'src-tauri/src/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-deps-v2-
            ${{ runner.os }}-deps-
            ${{ runner.os }}-

      - name: Cache Rust artifacts
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target/aarch64-apple-ios
            src-tauri/target/.rustc_info.json
          key: ${{ runner.os }}-ios-target-${{ hashFiles('**/Cargo.lock', 'src-tauri/src/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-ios-target-
            ${{ runner.os }}-rust-target-

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Build frontend (production)
        run: |
          cd frontend
          bun run build
        env:
          NODE_ENV: production

      - name: Install Tauri CLI (Fixed Version)
        run: |
          cargo install tauri-cli@2.0.0 --locked

      - name: Pre-warm Rust dependencies
        run: |
          cd src-tauri
          echo "Pre-warming Rust dependencies..."
          cargo fetch --target aarch64-apple-ios
          cargo check --target aarch64-apple-ios --release
          echo "Dependencies pre-warmed and pre-compiled"

      - name: Setup iOS build environment
        run: |
          cd src-tauri
          cargo tauri ios init

          # Copy configuration files
          cp ios-config/ExportOptions.plist gen/apple/ExportOptions.plist
          cp ios-config/src-tauri_iOS.entitlements gen/apple/src-tauri_iOS.entitlements
          cp ios-config/Podfile gen/apple/Podfile

          cd gen/apple
          # Install CocoaPods dependencies for iOS target
          pod install --repo-update || pod install
          cd ../../..

      - name: Setup iOS code signing (Enhanced)
        env:
          IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM || 'PCJU8QD9FN' }}
        run: |
          # Create secure keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          security create-keychain -p "$IOS_CERTIFICATE_PASSWORD" "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$IOS_CERTIFICATE_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$IOS_CERTIFICATE_P12" | base64 --decode > /tmp/cert.p12
          security import /tmp/cert.p12 -k "$KEYCHAIN_PATH" -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/xcodebuild
          
          # Configure keychain access
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$IOS_CERTIFICATE_PASSWORD" "$KEYCHAIN_PATH"
          
          # Verify certificate
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          
          rm -f /tmp/cert.p12
          echo "Keychain configured for code signing"

      - name: Install provisioning profile
        env:
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > /tmp/profile.mobileprovision
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/OpenCodeNexus_AppStore.mobileprovision
          rm -f /tmp/profile.mobileprovision
          echo "Provisioning profile installed"

      - name: Build iOS app (Tauri 2.x Fixed)
        run: |
          echo "::group::Starting iOS build at $(date)"
          START_TIME=$(date +%s)

          cd src-tauri
          echo "Building Rust code for iOS..."
          RUST_BACKTRACE=0 cargo build --target aarch64-apple-ios --release
          RUST_BUILD_TIME=$(($(date +%s) - START_TIME))
          echo "Rust build completed in ${RUST_BUILD_TIME}s"

          echo "Running Tauri iOS build (with proper signing)..."
          TAURI_START_TIME=$(date +%s)
          RUST_BACKTRACE=0 cargo tauri ios build --release --verbose
          TAURI_BUILD_TIME=$(($(date +%s) - TAURI_START_TIME))
          TOTAL_TIME=$(($(date +%s) - START_TIME))

          echo "::notice::Build timing: Rust=${RUST_BUILD_TIME}s, Tauri+Xcode=${TAURI_BUILD_TIME}s, Total=${TOTAL_TIME}s"
          echo "::endgroup::"
        env:
          RUST_LOG: info

      - name: Archive and Export iOS app (Simplified)
        run: |
          cd src-tauri/gen/apple

          # Verify workspace exists
          if [ ! -f "src-tauri.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not found"
            ls -la
            exit 1
          fi

          mkdir -p build/archives build/ipa

          # Create archive
          xcodebuild \
            -workspace src-tauri.xcworkspace \
            -scheme src-tauri_iOS \
            -configuration Release \
            -archivePath build/archives/OpenCodeNexus.xcarchive \
            -derivedDataPath build/DerivedData \
            archive \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM="PCJU8QD9FN" \
            OTHER_CODE_SIGN_FLAGS="--timestamp=none" \
            -verbose

          # Export IPA
          xcodebuild \
            -exportArchive \
            -archivePath build/archives/OpenCodeNexus.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa \
            -allowProvisioningUpdates \
            -verbose

          # Verify IPA
          IPA_FILE=$(find build/ipa -name "*.ipa" -type f)
          if [ -z "$IPA_FILE" ]; then
            echo "Error: IPA file not found after export"
            exit 1
          fi

          IPA_SIZE=$(du -h "$IPA_FILE" | cut -f1)
          echo "IPA exported: $IPA_FILE ($IPA_SIZE)"
          echo "IPA_FILE=$IPA_FILE" >> $GITHUB_ENV

      - name: Upload to TestFlight (Enhanced)
        if: github.event.inputs.upload_to_testflight != 'false' && (github.event_name != 'workflow_dispatch' || github.event.inputs.upload_to_testflight == 'true')
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}
        run: |
          # Setup API key
          TEMP_KEY_DIR=$(mktemp -d)
          echo "$APP_STORE_CONNECT_API_PRIVATE_KEY" | base64 --decode > "$TEMP_KEY_DIR/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8"
          
          # Validate IPA first
          echo "Validating IPA before upload..."
          xcrun altool \
            --validate-app \
            --type ios \
            --file "${{ env.IPA_FILE }}" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --apiKeysDir "$TEMP_KEY_DIR" \
            --verbose
          
          # Upload to TestFlight
          echo "Uploading to TestFlight..."
          xcrun altool \
            --upload-app \
            --type ios \
            --file "${{ env.IPA_FILE }}" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --apiKeysDir "$TEMP_KEY_DIR" \
            --verbose
          
          echo "TestFlight upload completed successfully"
          rm -rf "$TEMP_KEY_DIR"

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.IPA_FILE }}
          tag_name: ${{ env.TAG_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(env.TAG_NAME, 'beta') || contains(env.TAG_NAME, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload IPA to artifacts
        if: always() && env.IPA_FILE != ''
        uses: actions/upload-artifact@v4
        with:
          name: opencode-nexus-ios-${{ env.VERSION_NUMBER }}-build-${{ env.BUILD_NUMBER }}
          path: ${{ env.IPA_FILE }}
          retention-days: 30

      - name: Build success summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ‚úÖ iOS Build Successful

          ### üì± Build Details
          - **Version**: ${{ env.VERSION_NUMBER }} (Build: ${{ env.BUILD_NUMBER }})
          - **Runner**: macOS 14 (Apple Silicon)
          - **Xcode**: 15.4
          - **Rust Target**: aarch64-apple-ios
          - **Export Method**: App Store
          - **IPA Size**: $(du -h "${{ env.IPA_FILE }}" | cut -f1)

          ### üöÄ Next Steps
          1. Check [App Store Connect](https://appstoreconnect.apple.com/apps) for processing status
          2. Monitor TestFlight for build availability (5-15 minutes)
          3. Invite internal testers to test the build
          4. Verify app functionality on physical devices

          Release workflow completed successfully!
          EOF

      - name: Build failure summary
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ‚ùå iOS Build Failed

          ### üîç Troubleshooting Steps
          1. Check job logs above for specific error details
          2. Verify all secrets are configured correctly
          3. Ensure provisioning profile is not expired
          4. Check App Store Connect API key validity

          ### üìû Support
          - Use `development/ios_developer` subagent for iOS-specific issues
          - Check [IOS_BUILD_FIX_PLAN.md](IOS_BUILD_FIX_PLAN.md) for detailed fixes
          EOF
