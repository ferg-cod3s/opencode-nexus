name: Integration Tests

# ðŸš¨ TESTING POLICY: 100% PASS RATE REQUIRED
# All tests must pass. This workflow will fail the build on any test failure.
# Do not add continue-on-error: true to test steps.

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'src-tauri/**'
      - 'tests/**'
      - 'docker-compose.test.yml'
      - '.github/workflows/test-integration.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - 'src-tauri/**'
      - 'tests/**'
      - 'docker-compose.test.yml'
      - '.github/workflows/test-integration.yml'

# Allow only one concurrent deployment
concurrency:
  group: "integration"
  cancel-in-progress: false

jobs:
  integration-test:
    name: Integration Test Suite
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: opencode_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "ðŸ§¹ Cleaning up disk space before Docker build..."
          # Remove old Docker images and containers
          docker system prune -af --volumes
          # Clean package manager cache
          rm -rf ~/.npm ~/.cache ~/.cargo/registry/cache
          # Remove large temporary files
          find /tmp -name "*.tmp" -o -name "*.log" -mtime +7 -delete
          # Show available space
          df -h

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev postgresql-client redis-tools

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432 -U test_user; do sleep 1; done'
          timeout 60 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'

      - name: Setup test database
        env:
          PGPASSWORD: test_password
        run: |
          psql -h localhost -p 5432 -U test_user -d opencode_test -f tests/integration/init-test-db.sql

      - name: Run backend integration tests
        working-directory: ./src-tauri
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/opencode_test
          REDIS_URL: redis://localhost:6379
          RUST_LOG: debug
        run: echo "Backend integration tests skipped - not yet implemented"

      - name: Run frontend integration tests
        working-directory: ./frontend
        env:
          NODE_ENV: test
          VITE_DATABASE_URL: postgresql://test_user:test_password@localhost:5432/opencode_test
          VITE_REDIS_URL: redis://localhost:6379
        run: echo "Frontend integration tests skipped - not yet implemented"

  docker-integration-test:
    name: Docker Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Clean up before Docker build
        run: |
          echo "ðŸ§¹ Cleaning up Docker environment..."
          docker system prune -af --volumes
          # Remove large cache directories
          rm -rf ~/.npm ~/.cache ~/.cargo/registry/cache
          # Clean tmp
          find /tmp -name "*.tmp" -o -name "*.log" -mtime +1 -delete
          df -h

      - name: Build test images
        run: |
          docker compose -f docker-compose.test.yml build frontend-test backend-test mock-opencode-server

      - name: Run integration tests with Docker Compose
        run: |
          docker compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from frontend-test

      - name: Capture logs
        if: failure()
        run: |
          docker compose -f docker-compose.test.yml logs --no-color > docker-integration-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-integration-logs
          path: docker-integration-logs.txt
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v --remove-orphans