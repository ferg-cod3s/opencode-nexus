name: iOS TestFlight Release

on:
  push:
    tags:
      - 'ios-v*'
  workflow_dispatch:

env:
  RUST_BACKTRACE: 0
  RUST_LOG: warn
  NODE_ENV: production

jobs:
  build-ios:
    name: iOS TestFlight Build
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Self-Hosted Runner
        run: |
           if [ "$RUNNER_NAME" != "MacBook-Air" ]; then
             echo "‚ùå ERROR: This workflow must run on self-hosted runner 'MacBook-Air'"
             echo "üí∞ Hosted runners cost \$0.08/minute (~\$5/hour)"
             echo "üè† Self-hosted runner required for iOS certificates and environment"
             echo ""
             echo "üîß To fix:"
             echo "1. Check runner status: https://github.com/${{ github.repository }}/settings/actions/runners"
             echo "2. Restart runner: cd ~/github-runner && ./svc.restart"
             echo "3. Check runner logs: cd ~/github-runner && tail -f _diag/Runner_*.log"
             exit 1
           fi
           echo "‚úÖ Running on self-hosted runner: $RUNNER_NAME"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Install Bun
        uses: oven-sh/setup-bun@v1

      - name: Frontend Build
        run: |
           cd frontend
           bun install --frozen-lockfile
           bun run build

      - name: Rust Build
        run: |
           cd src-tauri
           cargo build --target aarch64-apple-ios --release --lib

      - name: Generate Xcode Project
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          cd src-tauri
          rm -rf gen/apple
          cargo tauri ios init

          # Use development signing as suggested by Xcode error
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "Apple Development"/g' gen/apple/src-tauri.xcodeproj/project.pbxproj

          # Disable Tauri CLI build script to avoid signing conflicts
          sed -i '' 's/shellScript = "cargo tauri ios xcode-script/shellScript = "echo \\"Using pre-built Rust library - skipping Tauri CLI\\"/g' gen/apple/src-tauri.xcodeproj/project.pbxproj

      - name: Build & Archive iOS App
        run: ./scripts/build-ios-archive.sh

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}
        run: |
          IPA_FILE=$(find build/ipa -name "*.ipa" | head -1)
          ./scripts/upload-testflight.sh "$IPA_FILE"

      - name: Upload Build Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-${{ github.sha }}
          path: build/ipa/*.ipa
          retention-days: 30
