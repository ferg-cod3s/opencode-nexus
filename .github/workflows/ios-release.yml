name: iOS TestFlight Release

on:
  push:
    tags:
      - 'ios-v*'
  workflow_dispatch:

env:
  RUST_BACKTRACE: 0
  RUST_LOG: warn
  NODE_ENV: production

jobs:
  build-ios:
    name: iOS TestFlight Build
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Self-Hosted Runner
        run: |
          if [ "$RUNNER_NAME" != "MacBook-Air" ]; then
            echo "âŒ ERROR: This workflow must run on self-hosted runner 'MacBook-Air'"
            echo "ðŸ’° Hosted runners cost \$0.08/minute (~\$5/hour)"
            echo "ðŸ  Self-hosted runner required for iOS certificates and environment"
            echo ""
            echo "ðŸ”§ To fix:"
            echo "1. Check runner status: https://github.com/${{ github.repository }}/settings/actions/runners"
            echo "2. Restart runner: cd ~/github-runner && ./svc.restart"
            echo "3. Check runner logs: cd ~/github-runner && tail -f _diag/Runner_*.log"
            exit 1
          fi
          echo "âœ… Running on self-hosted runner: $RUNNER_NAME"

      - name: Get version from Tauri config
        id: version
        run: |
          # Read version from tauri.conf.json
          VERSION=$(grep '"version"' src-tauri/tauri.conf.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
          BUILD_NUMBER=$(git rev-list --count HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Branch: ${{ github.ref_name }}"
          echo "Version: $VERSION (Build: $BUILD_NUMBER)"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios, aarch64-apple-ios-sim

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Frontend Build
        run: |
          cd frontend
          bun install --frozen-lockfile
           NODE_ENV=production bun run build
           cd ..

      - name: Rust Pre-build
        run: |
          cd src-tauri
          export IPHONEOS_DEPLOYMENT_TARGET=14.0
          cargo build --target aarch64-apple-ios --release --lib
           cd ..

      - name: Install iOS Dependencies
        run: |
           # Check if required tools are available (pre-installed on self-hosted runner)
           echo "Checking for required iOS development tools..."

           # Use full paths since we know where the tools are installed
           if /opt/homebrew/bin/xcodegen --version &> /dev/null; then
             echo "âœ… xcodegen found: $(/opt/homebrew/bin/xcodegen --version)"
           else
             echo "âŒ xcodegen not found at /opt/homebrew/bin/xcodegen"
             echo "Please ensure xcodegen is installed on the self-hosted runner"
             exit 1
           fi

           if /opt/homebrew/bin/pod --version &> /dev/null; then
             echo "âœ… cocoapods found: $(/opt/homebrew/bin/pod --version)"
           else
             echo "âš ï¸  cocoapods not found - attempting build without it"
             echo "Note: cocoapods may be required for iOS dependencies"
           fi

           echo "All iOS dependencies verified!"

      - name: iOS Project Setup
        run: |
           # Ensure xcodegen is in PATH
           export PATH="/opt/homebrew/bin:$PATH"
           cd src-tauri
           rm -rf gen/apple
           cargo tauri ios init
           mkdir -p gen/apple/Externals/arm64/Release
           cp target/aarch64-apple-ios/release/libsrc_tauri_lib.a gen/apple/Externals/arm64/Release/libapp.a

           # Configure code signing for distribution
           echo "Configuring code signing for distribution..."
           # Remove manual code signing settings to use automatic signing with correct profile
           sed -i '' '/CODE_SIGN_IDENTITY = "iPhone Distribution"/d' gen/apple/src-tauri.xcodeproj/project.pbxproj
           sed -i '' '/CODE_SIGN_STYLE = Manual/d' gen/apple/src-tauri.xcodeproj/project.pbxproj

           cd ..

      - name: Setup Code Signing
        env:
          IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Unlock login keychain and import certificate
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ~/Library/Keychains/login.keychain
          echo "$IOS_CERTIFICATE_P12" | base64 --decode > /tmp/cert.p12
          security import /tmp/cert.p12 \
            -k ~/Library/Keychains/login.keychain \
            -P "$IOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/xcodebuild
          rm -f /tmp/cert.p12

      - name: Install Provisioning Profile
        env:
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > /tmp/profile.mobileprovision
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/OpenCodeNexus_AppStore.mobileprovision
          rm -f /tmp/profile.mobileprovision

      - name: iOS Archive
        run: |
          cd src-tauri/gen/apple
          mkdir -p build/archives
           xcodebuild \
             -project src-tauri.xcodeproj \
             -scheme src-tauri_iOS \
             -configuration Release \
             -archivePath build/archives/OpenCodeNexus.xcarchive \
             archive \
             DEVELOPMENT_TEAM="PCJU8QD9FN"
          cd ../../..

      - name: Export IPA
        id: export
        run: |
          cd src-tauri/gen/apple
          mkdir -p build/ipa
          xcodebuild \
            -exportArchive \
            -archivePath build/archives/OpenCodeNexus.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa
          IPA_FILE=$(find build/ipa -name "*.ipa" -type f)
          echo "ipa-path=$IPA_FILE" >> $GITHUB_OUTPUT
          echo "IPA_FILE=$IPA_FILE" >> $GITHUB_ENV
          cd ../../..

      - name: Upload to TestFlight
        if: success()
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}
        run: |
          TEMP_KEY_DIR=$(mktemp -d)
          echo "$APP_STORE_CONNECT_API_PRIVATE_KEY" | base64 --decode > "$TEMP_KEY_DIR/AuthKey.p8"
          xcrun altool \
            --upload-app \
            --type ios \
            --file "${{ env.IPA_FILE }}" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --apiKeysDir "$TEMP_KEY_DIR" \
            --verbose
          rm -rf "$TEMP_KEY_DIR"

      - name: Create Sentry Release
        if: success()
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: Bearer $SENTRY_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"version":"${{ steps.version.outputs.version }}","projects":["opencode-nexus-frontend","opencode-nexus-backend"]}' \
            https://sentry.fergify.work/api/0/organizations/unforgettable-designs/releases/

      - name: Upload Build Artifacts
        if: always() && env.IPA_FILE != ''
        uses: actions/upload-artifact@v4
        with:
          name: opencode-nexus-ios-${{ steps.version.outputs.version }}-build-${{ steps.version.outputs.build }}
          path: ${{ env.IPA_FILE }}
          retention-days: 30
