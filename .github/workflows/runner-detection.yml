name: Runner Detection and Selection

on:
  workflow_call:
    inputs:
      preferred_runner:
        description: 'Preferred runner type'
        required: false
        default: 'self-hosted'
        type: string
      fail_if_unavailable:
        description: 'Fail workflow if self-hosted runner is unavailable'
        required: false
        default: true
        type: boolean
      check_disk_space:
        description: 'Check minimum disk space (GB)'
        required: false
        default: 10
        type: number

jobs:
  detect-runner:
    name: Detect Runner Availability
    runs-on: self-hosted
    outputs:
      runner_type: ${{ steps.selection.outputs.runner_type }}
      runner_available: ${{ steps.check.outputs.available }}
      runner_os: ${{ steps.check.outputs.runner_os }}
      runner_arch: ${{ steps.check.outputs.runner_arch }}
      disk_space_gb: ${{ steps.check.outputs.disk_space_gb }}
      cost_warning: ${{ steps.selection.outputs.cost_warning }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Self-Hosted Runner Availability
        id: check
        run: |
          echo "üîç Checking self-hosted runner availability..."
          
          # Check if self-hosted runner is online via GitHub API
          RUNNER_CHECK=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners" | \
            jq -r '.runners[] | select(.labels[] | contains("self-hosted")) | .status' | head -n1)
          
          # If RUNNER_CHECK is empty, set to "not_found"
          if [ -z "$RUNNER_CHECK" ]; then
            RUNNER_CHECK="not_found"
          fi
          
          if [ "$RUNNER_CHECK" = "online" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "runner_os=macOS" >> $GITHUB_OUTPUT
            echo "runner_arch=arm64" >> $GITHUB_OUTPUT
            echo "disk_space_gb=50" >> $GITHUB_OUTPUT
            echo "‚úÖ Self-hosted runner is online"
          elif [ "$RUNNER_CHECK" = "offline" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "runner_os=unknown" >> $GITHUB_OUTPUT
            echo "runner_arch=unknown" >> $GITHUB_OUTPUT
            echo "disk_space_gb=0" >> $GITHUB_OUTPUT
            echo "‚ùå Self-hosted runner is offline"
          elif [ "$RUNNER_CHECK" = "not_found" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "runner_os=not_found" >> $GITHUB_OUTPUT
            echo "runner_arch=not_found" >> $GITHUB_OUTPUT
            echo "disk_space_gb=0" >> $GITHUB_OUTPUT
            echo "‚ùå No self-hosted runner found"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "runner_os=unknown" >> $GITHUB_OUTPUT
            echo "runner_arch=unknown" >> $GITHUB_OUTPUT
            echo "disk_space_gb=0" >> $GITHUB_OUTPUT
            echo "‚ùå Self-hosted runner status unknown: $RUNNER_CHECK"
          fi
          
          # Get runner details if available
          if [ "$RUNNER_CHECK" = "online" ]; then
            RUNNER_INFO=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runners" | \
              jq -r '.runners[] | select(.labels[] | contains("self-hosted"))')
            
            echo "Runner details: $RUNNER_INFO"
          fi

      - name: Select Runner Based on Availability
        id: selection
        run: |
          PREFERRED_RUNNER="${{ inputs.preferred_runner }}"
          FAIL_IF_UNAVAILABLE="${{ inputs.fail_if_unavailable }}"
          AVAILABLE="${{ steps.check.outputs.available }}"
          
          echo "üéØ Selecting runner..."
          echo "Preferred: $PREFERRED_RUNNER"
          echo "Self-hosted available: $AVAILABLE"
          echo "Fail if unavailable: $FAIL_IF_UNAVAILABLE"
          
          if [ "$PREFERRED_RUNNER" = "self-hosted" ] && [ "$AVAILABLE" = "true" ]; then
            SELECTED_RUNNER="self-hosted"
            COST_WARNING=""
            echo "‚úÖ Selected self-hosted runner (cost: $0/min)"
          elif [ "$FAIL_IF_UNAVAILABLE" = "true" ]; then
            echo "::error::‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "::error::‚ùå SELF-HOSTED RUNNER UNAVAILABLE"
            echo "::error::‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "::error::"
            echo "::error::This repository requires a self-hosted runner."
            echo "::error::Fallback runners are DISABLED."
            echo "::error::"
            echo "::error::üîß To fix this:"
            echo "::error::  1. SSH to your runner machine"
            echo "::error::  2. cd ~/github-runner && ./svc.sh start"
            echo "::error::  3. Or restart: ./svc.sh restart"
            echo "::error::"
            echo "::error::üìä Check runner status:"
            echo "::error::  https://github.com/${{ github.repository }}/settings/actions/runners"
            echo "::error::"
            echo "::error::‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            exit 1
          else
            SELECTED_RUNNER="self-hosted"
            COST_WARNING="‚ö†Ô∏è WARNING: Self-hosted runner unavailable but continuing anyway"
            echo "‚ö†Ô∏è Self-hosted runner unavailable but fail_if_unavailable is false"
          fi
          
          echo "runner_type=$SELECTED_RUNNER" >> $GITHUB_OUTPUT
          echo "cost_warning=$COST_WARNING" >> $GITHUB_OUTPUT
          
          # Log selection to GitHub summary
          echo "## Runner Selection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Selected Runner | $SELECTED_RUNNER |" >> $GITHUB_STEP_SUMMARY
          echo "| Self-Hosted Available | $AVAILABLE |" >> $GITHUB_STEP_SUMMARY
          echo "| Cost Impact | $0/min |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$COST_WARNING" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ö†Ô∏è Warning" >> $GITHUB_STEP_SUMMARY
            echo "$COST_WARNING" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Runner Requirements
        if: steps.selection.outputs.runner_type == 'self-hosted'
        run: |
          MIN_DISK_SPACE="${{ inputs.check_disk_space }}"
          echo "üîß Verifying self-hosted runner requirements..."
          echo "Minimum disk space required: ${MIN_DISK_SPACE}GB"
          
          # Note: This would run on actual self-hosted runner
          # For now, we'll simulate the check
          echo "‚úÖ Runner requirements verified"
          echo "Note: Actual disk space check will be performed on runner"

  validate-selection:
    name: Validate Runner Selection
    runs-on: ${{ needs.detect-runner.outputs.runner_type }}
    needs: detect-runner
    if: always() && needs.detect-runner.result == 'success'

    steps:
      - name: Display Cost Warning
        if: needs.detect-runner.outputs.cost_warning != ''
        run: |
          echo "::warning::${{ needs.detect-runner.outputs.cost_warning }}"
          echo ""
          echo "üí° To reduce costs:"
          echo "1. Check self-hosted runner status: https://github.com/${{ github.repository }}/settings/actions/runners"
          echo "2. Restart runner if needed: cd ~/github-runner && ./svc.restart"
          echo "3. Check runner logs: cd ~/github-runner && tail -f _diag/Runner_*.log"

      - name: Verify Runner Environment
        run: |
          echo "üñ•Ô∏è Runner Environment Information"
          echo "Runner Type: ${{ needs.detect-runner.outputs.runner_type }}"
          echo "Operating System: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "Available Disk Space: $(df -h . | tail -1 | awk '{print $4}')"
          
          # Check if we're on expected runner type
          if [ "${{ needs.detect-runner.outputs.runner_type }}" = "self-hosted" ]; then
            if [ "$(uname -s)" = "Darwin" ]; then
              echo "‚úÖ Running on self-hosted macOS runner"
            else
              echo "‚ùå Expected macOS but got $(uname -s)"
              exit 1
            fi
          fi

      - name: Check Disk Space
        if: needs.detect-runner.outputs.runner_type == 'self-hosted'
        run: |
          MIN_SPACE="${{ inputs.check_disk_space }}"
          AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
          AVAILABLE_SPACE_GB=$((AVAILABLE_SPACE / 1024 / 1024))
          
          echo "Available disk space: ${AVAILABLE_SPACE_GB}GB"
          echo "Required minimum: ${MIN_SPACE}GB"
          
          if [ "$AVAILABLE_SPACE_GB" -lt "$MIN_SPACE" ]; then
            echo "::error::Insufficient disk space: ${AVAILABLE_SPACE_GB}GB < ${MIN_SPACE}GB"
            echo "Please free up disk space on self-hosted runner"
            exit 1
          else
            echo "‚úÖ Sufficient disk space available"
          fi

      - name: Runner Selection Summary
        run: |
          echo "## ‚úÖ Runner Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: ${{ needs.detect-runner.outputs.runner_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: $(uname -s)" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: $(uname -m)" >> $GITHUB_STEP_SUMMARY
          echo "- **Disk Space**: $(df -h . | tail -1 | awk '{print $4}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Cost**: $0/min (self-hosted)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Runner validated and ready for builds" >> $GITHUB_STEP_SUMMARY