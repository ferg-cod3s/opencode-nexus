name: Runner Detection and Selection

on:
  workflow_call:
    inputs:
      preferred_runner:
        description: 'Preferred runner type'
        required: false
        default: 'self-hosted'
        type: string
      fallback_runner:
        description: 'Fallback runner if self-hosted is unavailable'
        required: false
        default: 'macos-14'
        type: string
      fail_if_unavailable:
        description: 'Fail workflow if self-hosted runner is unavailable'
        required: false
        default: true
        type: boolean
      require_macos:
        description: 'Whether macOS is required'
        required: false
        default: true
        type: boolean
      check_disk_space:
        description: 'Check minimum disk space (GB)'
        required: false
        default: 10
        type: number
    outputs:
      runner_type:
        description: 'The selected runner type to use'
        value: ${{ jobs.detect-runner.outputs.runner_type }}
      runner_available:
        description: 'Whether self-hosted runner is available'
        value: ${{ jobs.detect-runner.outputs.runner_available }}
      cost_warning:
        description: 'Cost warning message if using paid runner'
        value: ${{ jobs.detect-runner.outputs.cost_warning }}

jobs:
  detect-runner:
    name: Detect Runner Availability
    # CRITICAL: Use a lightweight GitHub-hosted runner to check self-hosted availability
    # This avoids the circular dependency of needing self-hosted to check if self-hosted is available
    runs-on: ubuntu-latest
    outputs:
      runner_type: ${{ steps.selection.outputs.runner_type }}
      runner_available: ${{ steps.check.outputs.available }}
      cost_warning: ${{ steps.selection.outputs.cost_warning }}

    steps:
      - name: Check Self-Hosted Runner Availability via API
        id: check
        run: |
          echo "ðŸ” Checking self-hosted runner availability via GitHub API..."
          echo ""
          
          # Query GitHub API for runner status
          # Note: This runs on ubuntu-latest (always available) to check self-hosted status
          RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runners")
          
          # Check if we got a valid response
          if echo "$RESPONSE" | grep -q '"total_count"'; then
            TOTAL_RUNNERS=$(echo "$RESPONSE" | grep -o '"total_count":[0-9]*' | cut -d: -f2)
            echo "Total runners registered: $TOTAL_RUNNERS"
            
            # Look for online self-hosted runners
            # Using grep since jq may not be available on all runners
            if echo "$RESPONSE" | grep -q '"status":"online"'; then
              # Check if it's a self-hosted runner that's online
              if echo "$RESPONSE" | grep -B5 '"status":"online"' | grep -q '"self-hosted"'; then
                echo "available=true" >> $GITHUB_OUTPUT
                echo "âœ… Self-hosted runner is ONLINE"
                
                # Try to extract runner name
                RUNNER_NAME=$(echo "$RESPONSE" | grep -o '"name":"[^"]*"' | head -1 | cut -d'"' -f4)
                echo "Runner name: $RUNNER_NAME"
              else
                echo "available=false" >> $GITHUB_OUTPUT
                echo "âš ï¸ Online runner found but not self-hosted"
              fi
            else
              echo "available=false" >> $GITHUB_OUTPUT
              echo "âŒ No online self-hosted runners found"
              
              # Check if runner exists but is offline
              if echo "$RESPONSE" | grep -q '"status":"offline"'; then
                echo "âš ï¸ Self-hosted runner exists but is OFFLINE"
                echo ""
                echo "ðŸ”§ To bring it online:"
                echo "   1. SSH to your runner machine"
                echo "   2. cd ~/github-runner && ./svc.sh start"
              fi
            fi
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "âŒ Could not query runner status (API error or no runners configured)"
          fi

      - name: Select Runner Based on Availability
        id: selection
        run: |
          PREFERRED="${{ inputs.preferred_runner }}"
          FALLBACK="${{ inputs.fallback_runner }}"
          AVAILABLE="${{ steps.check.outputs.available }}"
          FAIL_IF_UNAVAILABLE="${{ inputs.fail_if_unavailable }}"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
          echo "â”ƒ  ðŸŽ¯ Runner Selection                        â”ƒ"
          echo "â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«"
          echo "â”ƒ  Preferred: $PREFERRED"
          echo "â”ƒ  Fallback: $FALLBACK"
          echo "â”ƒ  Self-hosted available: $AVAILABLE"
          echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
          echo ""
          
          if [ "$AVAILABLE" = "true" ]; then
            # Self-hosted is available - use it
            echo "runner_type=self-hosted" >> $GITHUB_OUTPUT
            echo "cost_warning=" >> $GITHUB_OUTPUT
            echo "âœ… Selected: self-hosted (cost: \$0/min)"
          elif [ "$FAIL_IF_UNAVAILABLE" = "true" ]; then
            # Self-hosted required but not available - fail
            echo ""
            echo "::error::â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "::error::âŒ SELF-HOSTED RUNNER REQUIRED BUT UNAVAILABLE"
            echo "::error::â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "::error::"
            echo "::error::This workflow requires a self-hosted runner."
            echo "::error::Fallback to GitHub-hosted runners is DISABLED."
            echo "::error::"
            echo "::error::ðŸ”§ To fix this:"
            echo "::error::  1. SSH to your runner machine"
            echo "::error::  2. cd ~/github-runner && ./svc.sh start"
            echo "::error::"
            echo "::error::ðŸ“Š Check runner status:"
            echo "::error::  https://github.com/${{ github.repository }}/settings/actions/runners"
            echo "::error::â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            # Self-hosted not available - use fallback
            echo "runner_type=$FALLBACK" >> $GITHUB_OUTPUT
            COST_MSG="âš ï¸ Using GitHub-hosted runner ($FALLBACK) - self-hosted unavailable"
            echo "cost_warning=$COST_MSG" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Selected: $FALLBACK (fallback - self-hosted unavailable)"
            echo "   Note: GitHub-hosted macOS runners incur costs"
          fi

      - name: Generate Summary
        run: |
          RUNNER="${{ steps.selection.outputs.runner_type }}"
          AVAILABLE="${{ steps.check.outputs.available }}"
          WARNING="${{ steps.selection.outputs.cost_warning }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ¯ Runner Detection Summary
          
          | Property | Value |
          |----------|-------|
          | **Selected Runner** | \`$RUNNER\` |
          | **Self-Hosted Available** | $AVAILABLE |
          | **Cost** | $( [ "$RUNNER" = "self-hosted" ] && echo "\$0/min âœ…" || echo "GitHub-hosted rates apply âš ï¸" ) |
          
          EOF
          
          if [ -n "$WARNING" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### âš ï¸ Cost Warning
          
          $WARNING
          
          **To reduce costs**, ensure the self-hosted runner is online:
          1. Check status: https://github.com/${{ github.repository }}/settings/actions/runners
          2. If offline: \`cd ~/github-runner && ./svc.sh start\`
          
          EOF
          fi
